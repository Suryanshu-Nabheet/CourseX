// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String       @id // Clerk User ID
  name          String
  email         String       @unique
  image         String?
  role          String       @default("STUDENT") // SQLite doesn't support enums
  courses       Course[]     @relation("InstructorCourses")
  enrollments   Enrollment[]
  reviews       Review[]     // Added relation for Review
  wishlists     Wishlist[]   // Added relation for Wishlist
  payments      Payment[]    // Added relation for Payment
  notes         Note[]       // Added relation for Note
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  lessonProgress LessonProgress[]
}

model Course {
  id            String       @id @default(cuid())
  title         String
  slug          String       @unique
  description   String
  category      String
  thumbnailUrl  String
  introVideoUrl String?
  difficulty    String?
  language      String?
  price         Float        @default(0)
  published     Boolean      @default(false)
  revenueSplit  Float?       // Instructor revenue split percentage (null = default platform fee)
  instructorId  String
  instructor    User         @relation("InstructorCourses", fields: [instructorId], references: [id])
  lessons       Lesson[]
  enrollments   Enrollment[]
  reviews       Review[]
  wishlists     Wishlist[]   // Added relation for Wishlist
  payments      Payment[]    // Added relation for Payment
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model Lesson {
  id          String     @id @default(cuid())
  title       String
  description String?
  videoUrl    String
  order       Int
  courseId    String
  course      Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  resources   Resource[]
  notes       Note[]     // Added relation for Note
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  lessonProgress LessonProgress[] // Added relation for LessonProgress

  @@index([courseId])
}

model Resource {
  id        String   @id @default(cuid())
  url       String
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lessonId])
}

model Enrollment {
  id        String   @id @default(cuid())
  studentId String
  courseId  String
  progress  Int      @default(0) // Percentage 0-100
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [studentId], references: [id])
  course    Course   @relation(fields: [courseId], references: [id])

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5
  comment   String?
  userId    String
  userName  String?
  userImage String?
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([courseId])
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Payment {
  id              String   @id @default(cuid())
  userId          String
  courseId        String
  paymentIntentId String   @unique
  amount          Float
  currency        String   @default("USD")
  status          String   @default("pending") // pending, completed, failed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id])
  course          Course   @relation(fields: [courseId], references: [id])

  @@index([userId])
  @@index([courseId])
}

model Note {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
}

model LessonProgress {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  completed Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}
